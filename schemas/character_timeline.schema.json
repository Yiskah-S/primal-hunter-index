{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"title": "Character Timeline Snapshot",
	"type": "array",
	"items": {
		"type": "object",
		"required": ["day", "scene_id", "stats", "source_ref"],
		"properties": {
			"day": {
				"type": "integer",
				"description": "In-story day count when this snapshot occurred"
			},
		"scene_id": {
			"type": "string",
			"description": "Unique ID linking this snapshot to a records scene",
			"pattern": "^\\d{2}-\\d{2}-\\d{2}$"
		},
			"source_file": {
				"type": "string",
				"description": "Filepath to source material for this snapshot"
			},
		"reason": {
			"type": "string",
			"description": "Short narrative for why this timeline snapshot exists"
		},
		"notes": {
			"type": "string",
			"description": "Extended commentary or reviewer notes for this snapshot"
		},
		"tags": {
			"type": "array",
			"description": "Registry-backed tags describing this point on the timeline",
			"items": {
				"type": "string",
				"pattern": "^[a-z0-9_]+$"
			},
			"uniqueItems": true
		},
			"level": { "type": "integer" },
			"class_level": { "type": "integer" },
			"race_level": { "type": "integer" },
			"tier": { "type": "string" },
			"class": { "type": "string" },
			"race": { "type": "string" },
			"titles": {
				"type": "array",
				"items": { "type": "string" }
			},
			"skills": {
				"type": "array",
				"description": "Current active skills as strings with rarity (e.g. 'Basic Archery (Inferior)')",
				"items": { "type": "string" }
			},
			"skill_log": {
				"type": "array",
				"description": "Log of skill acquisition or upgrade events",
				"items": {
					"type": "object",
					"required": ["skill", "source"],
					"properties": {
						"skill": { "type": "string" },
						"source": { "type": "string" },
						"line": {
							"type": "integer",
							"description": "Optional line number in the source material"
						}
					},
					"additionalProperties": false
				}
			},
			"equipment": {
				"type": "array",
				"description": "List of equipped or held gear at this moment",
				"items": { "type": "string" }
			},
			"resources": {
				"type": "object",
				"properties": {
					"HP": { "$ref": "#/$defs/resource_block" },
					"MP": { "$ref": "#/$defs/resource_block" },
					"Stamina": { "$ref": "#/$defs/resource_block" }
				},
				"additionalProperties": false
			},
			"stats": {
				"type": "object",
				"required": ["total"],
				"properties": {
					"total": {
						"type": "object",
						"patternProperties": {
							".+": { "type": "number" }
						}
					},
					"sources": {
						"type": "object",
						"properties": {
							"base":   { "$ref": "#/items/properties/stats/properties/total" },
							"race":   { "$ref": "#/items/properties/stats/properties/total" },
							"class":  { "$ref": "#/items/properties/stats/properties/total" },
							"titles": { "$ref": "#/items/properties/stats/properties/total" },
							"equipment": { "$ref": "#/items/properties/stats/properties/total" },
							"free_allocation": { "$ref": "#/items/properties/stats/properties/total" }
						},
						"additionalProperties": false
					}
				},
				"additionalProperties": false
			},
			"stat_log": {
				"type": "array",
				"description": "Discrete changes to stats from titles, classes, items, etc",
				"items": {
					"type": "object",
					"properties": {
						"source": { "type": "string" },
						"change": {
							"type": "object",
							"patternProperties": {
								".+": { "type": "number" }
							}
						}
					},
					"required": ["source", "change"],
					"additionalProperties": false
				}
			},
			"source_ref": {
				"description": "Exact scene and line span supporting this snapshot",
				"oneOf": [
					{ "$ref": "#/$defs/source_range" },
					{
						"type": "array",
						"items": { "$ref": "#/$defs/source_range" },
						"minItems": 1
					}
				]
			}
		},
		"additionalProperties": false
	},
	"$defs": {
		"resource_block": {
			"type": "object",
			"required": ["max", "current", "derived_from"],
			"properties": {
				"max": { "type": "number" },
				"current": { "type": "number" },
				"derived_from": { "type": ["string", "array"] }
			},
			"additionalProperties": false
		},
		"source_range": {
			"type": "object",
			"required": ["scene_id", "line_start", "line_end"],
			"properties": {
				"scene_id": {
					"type": "string",
					"pattern": "^\\d{2}-\\d{2}-\\d{2}$"
				},
				"line_start": {
					"type": "integer",
					"minimum": 1
				},
				"line_end": {
					"type": "integer",
					"minimum": 1
				}
			},
			"additionalProperties": false
		}
	}
}
