{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "https://primal-hunter.local/schemas/shared/source_ref.schema.json",
	"title": "source_ref",
	"$comment": "See docs/contracts/source_ref_contract_v1.1.md#object-definition",
	"type": "object",
	"description": "Canonical citation object proving a fact, event, or tag.",
	"required": ["scene_id", "line_start", "line_end"],
	"properties": {
		"type": {
			"type": "string",
			"enum": ["scene", "wiki", "user", "inferred", "external"],
			"description": "Where this citation originates."
		},
		"scene_id": {
			"type": "string",
			"pattern": "^\\d{2}\\.\\d{2}\\.\\d{2}$",
			"description": "Scene identifier in dotted BB.CC.SS format (Book, Chapter, Scene)."
		},
		"line_start": {
			"type": "integer",
			"minimum": 1,
			"description": "First line number (inclusive) backing this reference."
		},
		"line_end": {
			"type": "integer",
			"minimum": 1,
			"description": "Last line number (inclusive) backing this reference."
		},
		"quote": {
			"type": "string",
			"maxLength": 320,
			"description": "Optional quote excerpt to provide immediate context."
		},
		"anchor_hash": {
			"type": "string",
			"description": "Stable hash of the cited excerpt to survive line shifts.",
			"pattern": "^[a-f0-9]{16,64}$"
		},
		"certainty": {
			"type": "string",
			"enum": ["high", "medium", "low"],
			"description": "Confidence rating for inferred or external citations."
		},
		"inference_type": {
			"type": "string",
			"enum": [
				"none",
				"character_misinterpretation",
				"implied_system_rule",
				"redaction_gap",
				"sarcasm_literalized",
				"unreliable_narrator",
				"translation_noise",
				"other"
			],
			"default": "none",
			"description": "Why this reference is inferred rather than explicit."
		},
		"inference_note": {
			"type": "string",
			"maxLength": 800,
			"description": "Supporting explanation for inferred references."
		}
	},
	"allOf": [
		{
			"if": { "properties": { "inference_type": { "const": "none" } }, "required": ["inference_type"] },
			"then": { "not": { "required": ["inference_note"] } },
			"else": { "required": ["inference_note"] }
		}
	],
	"additionalProperties": false
}
